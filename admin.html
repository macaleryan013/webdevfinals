<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - POS System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Additional styles for modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 24px;
            cursor: pointer;
        }

        .form-control {
            padding: 0.5rem;
            margin: 0.5rem 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Admin Dashboard</h2>
            <div class="nav-item" data-target="monitoring">
                <i class="fas fa-chart-line"></i> Monitoring
            </div>
            <div class="nav-item" data-target="users">
                <i class="fas fa-users"></i> Users
            </div>
            <div class="nav-item" data-target="products">
                <i class="fas fa-box"></i> Products
            </div>
            <div class="nav-item" data-target="supplies">
                <i class="fas fa-truck"></i> Supplies
            </div>
            <div class="nav-item" data-target="inventory">
                <i class="fas fa-warehouse"></i> Inventory
            </div>
            <div class="nav-item" data-target="transactions">
                <i class="fas fa-exchange-alt"></i> Transactions
            </div>
            <div class="nav-item" data-target="sales-report">
                <i class="fas fa-file-invoice-dollar"></i> Sales Report
            </div>
            <div class="nav-item" data-target="settings">
                <i class="fas fa-cog"></i> Settings
            </div>
            <div class="nav-item" onclick="window.location.href='pos.html'">
                <i class="fas fa-cash-register"></i> Open POS
            </div>
            <button class="btn btn-danger logout-btn" style="margin-top: auto;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 class="user-info">Welcome, Admin</h1>
            </div>

            <!-- Monitoring Section -->
            <div id="monitoring" class="content-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Products</h3>
                        <div class="value" id="totalProducts">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Sales</h3>
                        <div class="value" id="totalSales">â‚±0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div class="value" id="totalUsers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Low Stock Items</h3>
                        <div class="value" id="lowStock">0</div>
                    </div>
                </div>
                <div class="card">
                    <h2>Product Analytics</h2>
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                        <div style="width: 45%; min-width: 300px;">
                            <h3>Top Selling Products</h3>
                            <canvas id="salesPieChart"></canvas>
                        </div>
                        <div style="width: 45%; min-width: 300px;">
                            <h3>Stock Distribution</h3>
                            <canvas id="stockPieChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>Recent Transactions</h2>
                    <div class="table-container">
                        <table id="recentTransactions">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction ID</th>
                                    <th>Amount</th>
                                    <th>Items</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <div id="users" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Manage Users</h2>
                        <button class="btn btn-primary" onclick="showAddUserModal()">
                            <i class="fas fa-plus"></i> Add User
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Products Section -->
            <div id="products" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Manage Products</h2>
                        <button class="btn btn-primary" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i> Add Product
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="productsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Price</th>
                                    <th>Category</th>
                                    <th>Stock</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Supplies Section -->
            <div id="supplies" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Supply List</h2>
                        <button class="btn btn-primary" onclick="showAddSupplyModal()">
                            <i class="fas fa-plus"></i> Add Supply
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="suppliesTable">
                            <thead>
                                <tr>
                                    <th>Supplier</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Inventory Section -->
            <div id="inventory" class="content-section">
                <div class="card">
                    <h2>Inventory Management</h2>
                    <div class="table-container">
                        <table id="inventoryTable">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>Category</th>
                                    <th>Current Stock</th>
                                    <th>Reorder Level</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Section -->
            <div id="transactions" class="content-section">
                <div class="card">
                    <h2>Transaction History</h2>
                    <div class="table-container">
                        <table id="transactionsTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Transaction ID</th>
                                    <th>Items</th>
                                    <th>Total</th>
                                    <th>Cashier</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Sales Report Section -->
            <div id="sales-report" class="content-section">
                <div class="card">
                    <div class="card-header">
                        <h2>Sales Report</h2>
                        <div>
                            <input type="date" id="startDate" class="form-control">
                            <input type="date" id="endDate" class="form-control">
                            <button class="btn btn-primary" onclick="generateSalesReport()">
                                Generate Report
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="salesReportTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Total Sales</th>
                                    <th>Items Sold</th>
                                    <th>Average Transaction</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="content-section">
                <div class="card">
                    <h2>User Settings</h2>
                    <form id="settingsForm" class="form-group">
                        <div class="form-group">
                            <label for="currentPassword">Current Password</label>
                            <input type="password" id="currentPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New User</h2>
            <form id="addUserForm">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newUserPassword">Password</label>
                    <input type="password" id="newUserPassword" required>
                </div>
                <div class="form-group">
                    <label for="newUserRole">Role</label>
                    <select id="newUserRole" required>
                        <option value="staff">Staff</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-primary">Add User</button>
            </form>
        </div>
    </div>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Product</h2>
            <form id="addProductForm">
                <div class="form-group">
                    <label for="productName">Product Name</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productPrice">Price</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Category</label>
                    <input type="text" id="productCategory" required>
                </div>
                <div class="form-group">
                    <label for="productStock">Initial Stock</label>
                    <input type="number" id="productStock" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Product</button>
            </form>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Edit Product</h2>
            <form id="editProductForm">
                <input type="hidden" id="editProductId">
                <div class="form-group">
                    <label for="editProductName">Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">Price</label>
                    <input type="number" id="editProductPrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="editProductCategory">Category</label>
                    <input type="text" id="editProductCategory" required>
                </div>
                <div class="form-group">
                    <label for="editProductStock">Current Stock</label>
                    <input type="number" id="editProductStock" required>
                </div>
                <div class="form-group">
                    <label for="editReorderLevel">Reorder Level</label>
                    <input type="number" id="editReorderLevel" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary">Update Product</button>
            </form>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div id="addStockModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Update Stock</h2>
            <form id="addStockForm">
                <input type="hidden" id="stockProductId">
                <div class="form-group">
                    <label for="currentStock">Current Stock</label>
                    <input type="number" id="currentStock" readonly>
                </div>
                <div class="form-group">
                    <label for="stockToAdd">Stock to Add</label>
                    <input type="number" id="stockToAdd" min="1" required>
                </div>
                <div class="form-group">
                    <label for="reorderLevel">Reorder Level</label>
                    <input type="number" id="reorderLevel" min="0" required>
                </div>
                <button type="submit" class="btn btn-primary">Update Stock</button>
            </form>
        </div>
    </div>

    <!-- Add Supply Modal -->
    <div id="addSupplyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Supply</h2>
            <form id="addSupplyForm">
                <div class="form-group">
                    <label for="supplierName">Supplier Name</label>
                    <input type="text" id="supplierName" required>
                </div>
                <div class="form-group">
                    <label for="supplyProduct">Product</label>
                    <select id="supplyProduct" required>
                        <option value="">Select Product</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="supplyQuantity">Quantity</label>
                    <input type="number" id="supplyQuantity" min="1" required>
                </div>
                <div class="form-group">
                    <label for="supplyDate">Date</label>
                    <input type="date" id="supplyDate" required>
                </div>
                <button type="submit" class="btn btn-primary">Add Supply</button>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // Admin-specific JavaScript
        function updateDashboardStats() {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];

            // Update stats
            document.getElementById('totalProducts').textContent = products.length;
            document.getElementById('totalUsers').textContent = users.length;
            
            const totalSales = transactions.reduce((sum, t) => sum + t.total, 0);
            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            
            const lowStock = products.filter(p => p.stock < 10).length;
            document.getElementById('lowStock').textContent = lowStock;

            // Update recent transactions
            const recentTransactions = transactions.slice(-5).reverse();
            const tbody = document.querySelector('#recentTransactions tbody');
            tbody.innerHTML = recentTransactions.map(t => `
                <tr>
                    <td>${formatDate(t.date)}</td>
                    <td>${t.id}</td>
                    <td>${formatCurrency(t.total)}</td>
                    <td>${t.items.length} items</td>
                </tr>
            `).join('');

            updatePieChart();
            updateStockPieChart();
        }

        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteUser('${user.username}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function loadProducts() {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const tbody = document.querySelector('#productsTable tbody');
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${formatCurrency(product.price)}</td>
                    <td>${product.category}</td>
                    <td>${product.stock}</td>
                    <td>
                        <button class="btn btn-primary" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function loadTransactions() {
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            // Sort transactions by date in descending order (newest first)
            const sortedTransactions = transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = sortedTransactions.map(t => `
                <tr>
                    <td>${formatDate(t.date)}</td>
                    <td>${t.id}</td>
                    <td>${t.items.length} items</td>
                    <td>${formatCurrency(t.total)}</td>
                    <td>${t.cashier}</td>
                </tr>
            `).join('');
        }

        function generateSalesReport() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!startDate || !endDate) {
                showAlert('Please select both start and end dates', 'danger');
                return;
            }

            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            
            const filteredTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date >= startDate && date <= endDate;
            });

            if (filteredTransactions.length === 0) {
                document.querySelector('#salesReportTable tbody').innerHTML = 
                    '<tr><td colspan="4" style="text-align: center;">No transactions found for the selected period</td></tr>';
                return;
            }

            const dailySales = {};
            filteredTransactions.forEach(t => {
                const date = new Date(t.date).toLocaleDateString();
                if (!dailySales[date]) {
                    dailySales[date] = {
                        total: 0,
                        items: 0,
                        count: 0
                    };
                }
                dailySales[date].total += t.total;
                dailySales[date].items += t.items.reduce((sum, item) => sum + item.quantity, 0);
                dailySales[date].count++;
            });

            const tbody = document.querySelector('#salesReportTable tbody');
            tbody.innerHTML = Object.entries(dailySales).map(([date, data]) => `
                <tr>
                    <td>${date}</td>
                    <td>${formatCurrency(data.total)}</td>
                    <td>${data.items}</td>
                    <td>${formatCurrency(data.total / data.count)}</td>
                </tr>
            `).join('');

            // Add summary row
            const totalSales = Object.values(dailySales).reduce((sum, data) => sum + data.total, 0);
            const totalItems = Object.values(dailySales).reduce((sum, data) => sum + data.items, 0);
            const totalTransactions = Object.values(dailySales).reduce((sum, data) => sum + data.count, 0);
            
            tbody.innerHTML += `
                <tr class="summary-row">
                    <td><strong>Total</strong></td>
                    <td><strong>${formatCurrency(totalSales)}</strong></td>
                    <td><strong>${totalItems}</strong></td>
                    <td><strong>${formatCurrency(totalSales / totalTransactions)}</strong></td>
                </tr>
            `;
        }

        // Modal functions
        function showAddUserModal() {
            document.getElementById('addUserModal').style.display = 'block';
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').style.display = 'block';
        }

        // Close modals when clicking the X
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                this.parentElement.parentElement.style.display = 'none';
            }
        });

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }

        // Form submissions
        document.getElementById('addUserForm').onsubmit = function(e) {
            e.preventDefault();
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;

            const users = JSON.parse(localStorage.getItem('users')) || [];
            users.push({ username, password, role });
            localStorage.setItem('users', JSON.stringify(users));

            document.getElementById('addUserModal').style.display = 'none';
            loadUsers();
            showAlert('User added successfully');
        };

        document.getElementById('addProductForm').onsubmit = function(e) {
            e.preventDefault();
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const newProduct = {
                id: products.length + 1,
                name: document.getElementById('productName').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value)
            };

            products.push(newProduct);
            localStorage.setItem('products', JSON.stringify(products));

            document.getElementById('addProductModal').style.display = 'none';
            loadProducts();
            updateDashboardStats();
            showAlert('Product added successfully');
        };

        document.getElementById('settingsForm').onsubmit = function(e) {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showAlert('New passwords do not match', 'danger');
                return;
            }

            const users = JSON.parse(localStorage.getItem('users')) || [];
            const currentUser = getCurrentUser();
            const userIndex = users.findIndex(u => u.username === currentUser.username);

            if (users[userIndex].password !== currentPassword) {
                showAlert('Current password is incorrect', 'danger');
                return;
            }

            users[userIndex].password = newPassword;
            localStorage.setItem('users', JSON.stringify(users));
            showAlert('Password updated successfully');
        };

        // Add deleteProduct function
        function deleteProduct(productId) {
            if (confirm('Are you sure you want to delete this product?')) {
                const products = JSON.parse(localStorage.getItem('products')) || [];
                const updatedProducts = products.filter(product => product.id !== productId);
                localStorage.setItem('products', JSON.stringify(updatedProducts));
                
                // Reload products table
                loadProducts();
                // Update dashboard stats
                updateDashboardStats();
                // Show success message
                showAlert('Product deleted successfully');
            }
        }

        // Add editProduct function
        function editProduct(productId) {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const product = products.find(p => p.id === productId);
            
            if (product) {
                document.getElementById('editProductId').value = product.id;
                document.getElementById('editProductName').value = product.name;
                document.getElementById('editProductPrice').value = product.price;
                document.getElementById('editProductCategory').value = product.category;
                document.getElementById('editProductStock').value = product.stock;
                document.getElementById('editReorderLevel').value = product.reorderLevel || 10;
                document.getElementById('editProductModal').style.display = 'block';
            }
        }

        // Handle edit product form submission
        document.getElementById('editProductForm').onsubmit = function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('editProductId').value);
            const updatedProduct = {
                id: productId,
                name: document.getElementById('editProductName').value,
                price: parseFloat(document.getElementById('editProductPrice').value),
                category: document.getElementById('editProductCategory').value,
                stock: parseInt(document.getElementById('editProductStock').value),
                reorderLevel: parseInt(document.getElementById('editReorderLevel').value)
            };
            
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex !== -1) {
                products[productIndex] = updatedProduct;
                localStorage.setItem('products', JSON.stringify(products));
                
                document.getElementById('editProductModal').style.display = 'none';
                loadProducts();
                updateDashboardStats();
                showAlert('Product updated successfully');
            }
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize sample products if none exist
            if (!localStorage.getItem('products')) {
                const sampleProducts = [
                    {
                        id: 1,
                        name: "Product 1",
                        price: 100,
                        category: "Category 1",
                        stock: 20,
                        reorderLevel: 10
                    },
                    {
                        id: 2,
                        name: "Product 2",
                        price: 200,
                        category: "Category 2",
                        stock: 5,
                        reorderLevel: 10
                    },
                    {
                        id: 3,
                        name: "Product 3",
                        price: 300,
                        category: "Category 1",
                        stock: 0,
                        reorderLevel: 10
                    }
                ];
                localStorage.setItem('products', JSON.stringify(sampleProducts));
            }

            // Initialize sample transactions if none exist
            if (!localStorage.getItem('transactions')) {
                const today = new Date();
                const sampleTransactions = [
                    {
                        id: "TRX001",
                        date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 2).toISOString(),
                        items: [
                            { id: 1, name: "Product 1", quantity: 2, price: 100 },
                            { id: 2, name: "Product 2", quantity: 1, price: 200 }
                        ],
                        total: 400,
                        cashier: "admin"
                    },
                    {
                        id: "TRX002",
                        date: new Date(today.getFullYear(), today.getMonth(), today.getDate() - 1).toISOString(),
                        items: [
                            { id: 3, name: "Product 3", quantity: 1, price: 300 }
                        ],
                        total: 300,
                        cashier: "staff"
                    },
                    {
                        id: "TRX003",
                        date: today.toISOString(),
                        items: [
                            { id: 1, name: "Product 1", quantity: 1, price: 100 },
                            { id: 2, name: "Product 2", quantity: 2, price: 200 },
                            { id: 3, name: "Product 3", quantity: 1, price: 300 }
                        ],
                        total: 800,
                        cashier: "admin"
                    }
                ];
                localStorage.setItem('transactions', JSON.stringify(sampleTransactions));
            }

            checkAuth();
            setupNavigation();
            setupLogout();
            showSection('dashboard');
            updateDashboardStats();
            loadUsers();
            loadProducts();
            loadTransactions();
        });

        // Load inventory
        function loadInventory() {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const tbody = document.querySelector('#inventoryTable tbody');
            
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No products found</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${product.stock}</td>
                    <td>${product.reorderLevel || 10}</td>
                    <td>
                        <span class="stock-status ${getStockStatusClass(product)}">
                            ${getStockStatus(product)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-primary" onclick="showAddStockModal(${product.id})">
                            <i class="fas fa-plus"></i> Update Stock
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get stock status
        function getStockStatus(product) {
            if (product.stock <= 0) return 'Out of Stock';
            if (product.stock <= (product.reorderLevel || 10)) return 'Low Stock';
            return 'Normal';
        }

        // Get stock status class
        function getStockStatusClass(product) {
            if (product.stock <= 0) return 'status-out';
            if (product.stock <= (product.reorderLevel || 10)) return 'status-low';
            return 'status-normal';
        }

        // Show add stock modal
        function showAddStockModal(productId) {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const product = products.find(p => p.id === productId);
            
            if (product) {
                document.getElementById('stockProductId').value = product.id;
                document.getElementById('currentStock').value = product.stock;
                document.getElementById('stockToAdd').value = '';
                document.getElementById('reorderLevel').value = product.reorderLevel || 10;
                document.getElementById('addStockModal').style.display = 'block';
            }
        }

        // Handle add stock form submission
        document.getElementById('addStockForm').onsubmit = function(e) {
            e.preventDefault();
            
            const productId = parseInt(document.getElementById('stockProductId').value);
            const stockToAdd = parseInt(document.getElementById('stockToAdd').value);
            const reorderLevel = parseInt(document.getElementById('reorderLevel').value);
            
            const products = JSON.parse(localStorage.getItem('products')) || [];
            const productIndex = products.findIndex(p => p.id === productId);
            
            if (productIndex !== -1) {
                products[productIndex].stock += stockToAdd;
                products[productIndex].reorderLevel = reorderLevel;
                localStorage.setItem('products', JSON.stringify(products));
                
                document.getElementById('addStockModal').style.display = 'none';
                loadInventory();
                updateDashboardStats();
                showAlert('Stock updated successfully');
            }
        };

        // Add event listener for inventory section
        document.querySelector('[data-target="inventory"]').addEventListener('click', function() {
            showSection('inventory');
            loadInventory();
        });

        // Add styles for inventory
        const style = document.createElement('style');
        style.textContent = `
            .stock-status {
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                font-weight: 500;
            }

            .status-normal {
                background: #d4edda;
                color: #155724;
            }

            .status-low {
                background: #fff3cd;
                color: #856404;
            }

            .status-out {
                background: #f8d7da;
                color: #721c24;
            }
        `;
        document.head.appendChild(style);

        // Add styles for sales report
        const salesReportStyle = document.createElement('style');
        salesReportStyle.textContent = `
            .summary-row {
                background-color: #f8f9fa;
                font-weight: bold;
            }
            
            .summary-row td {
                border-top: 2px solid #dee2e6;
            }
        `;
        document.head.appendChild(salesReportStyle);

        // Initialize pie charts
        let salesPieChart = null;
        let stockPieChart = null;

        function initializePieCharts() {
            // Initialize sales pie chart
            const salesCtx = document.getElementById('salesPieChart').getContext('2d');
            salesPieChart = new Chart(salesCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Selling Products'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: â‚±${value.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });

            // Initialize stock pie chart
            const stockCtx = document.getElementById('stockPieChart').getContext('2d');
            stockPieChart = new Chart(stockCtx, {
                type: 'pie',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                            '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                            '#9966FF', '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 15,
                                padding: 10
                            }
                        },
                        title: {
                            display: true,
                            text: 'Product Stock Levels'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    return `${label}: ${value} units`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePieChart() {
            const transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            const products = JSON.parse(localStorage.getItem('products')) || [];
            
            // Create a map to store product totals
            const productTotals = {};
            
            // Calculate total sales for each product
            transactions.forEach(transaction => {
                transaction.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        const productName = product.name;
                        const saleAmount = item.price * item.quantity;
                        productTotals[productName] = (productTotals[productName] || 0) + saleAmount;
                    }
                });
            });
            
            // Sort products by total sales and get top 5
            const sortedProducts = Object.entries(productTotals)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            // Update chart data
            if (salesPieChart) {
                salesPieChart.data.labels = sortedProducts.map(([name]) => name);
                salesPieChart.data.datasets[0].data = sortedProducts.map(([,total]) => total);
                salesPieChart.options.plugins.title.text = 'Top 5 Selling Products';
                salesPieChart.update();
            }
        }

        function updateStockPieChart() {
            const products = JSON.parse(localStorage.getItem('products')) || [];
            
            // Sort products by stock level (lowest to highest)
            const sortedProducts = [...products].sort((a, b) => a.stock - b.stock);
            
            // Update chart data
            if (stockPieChart) {
                stockPieChart.data.labels = sortedProducts.map(product => product.name);
                stockPieChart.data.datasets[0].data = sortedProducts.map(product => product.stock);
                stockPieChart.update();
            }
        }

        // Update both charts when monitoring section is shown
        document.querySelector('[data-target="monitoring"]').addEventListener('click', function() {
            showSection('monitoring');
            if (!salesPieChart || !stockPieChart) {
                initializePieCharts();
            }
            updatePieChart();
            updateStockPieChart();
        });
    </script>
</body>
</html> 